<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSH Tracker - Profiles</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
<div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-md">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Student Profiles</h1>
    <a href="add-profile.html" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Add Profile</a>
  </div>

  <input type="text" id="searchInput" placeholder="Search by student name..." class="border p-2 rounded w-full mb-4">

  <div class="overflow-x-auto">
    <table class="w-full border border-gray-300 text-sm">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">Name</th>
          <th class="border p-2">Grade</th>
          <th class="border p-2">Total CSH Hours</th>
          <th class="border p-2">Actions</th>
        </tr>
      </thead>
      <tbody id="profilesTable"></tbody>
    </table>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxG4I4e8G_LJVDLqXChpZEI860bK1DhqeaINJ_NZK4kS7Z7nzgv1mv8Y867562xGKx7/exec";
const API_KEY = "mrxlaKkzHck1qt0A7LBd91oLMo2EwI79qvVtWeLh5zMptix2vL2wMiHVayE1xmz5";

let students = [];
let cshEntries = [];

async function fetchStudents() {
  const res = await fetch(`${API_URL}?sheet=Students`);
  students = await res.json();
}

async function fetchCSH() {
  const res = await fetch(`${API_URL}?sheet=CSH`);
  cshEntries = await res.json();
}

function calculateTotalHours(studentId) {
  return cshEntries
    .filter(entry => entry.studentId === studentId)
    .reduce((sum, e) => sum + parseFloat(e.hours), 0);
}

function renderProfiles(filter="") {
  const table = document.getElementById("profilesTable");
  table.innerHTML = "";
  const filtered = students.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()));
  filtered.forEach(student => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="border p-2">${student.name}</td>
      <td class="border p-2">${student.grade}</td>
      <td class="border p-2">${calculateTotalHours(student.id)}</td>
      <td class="border p-2">
        <a href="edit-profile.html?id=${student.id}" class="text-blue-600 underline">Edit / Add CSH</a>
      </td>
    `;
    table.appendChild(row);
  });
}

document.getElementById("searchInput").addEventListener("input", e => renderProfiles(e.target.value));

async function init() {
  await fetchStudents();
  await fetchCSH();
  renderProfiles();
}

init();
</script>
</body>
</html>
